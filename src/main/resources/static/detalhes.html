<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Chamado</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body>

<div id="navbar"></div>

<main>
    <div class="container">
        <h1>Detalhes do Chamado</h1>

        <div class="detalhes-wrapper">
            <!-- Card principal com informações do chamado -->
            <div id="conteudoChamado" class="detalhes-card">
                <!-- Preenchido via JS -->
            </div>

            <!-- Box lateral apenas para ADMIN -->
            <div id="adminBox" class="admin-section" style="display:none;">
                <h2>Ações do Administrador</h2>

                <label for="statusSelect">Status do chamado</label>
                <select id="statusSelect">
                    <option value="ABERTO">ABERTO</option>
                    <option value="EM_ANDAMENTO">EM ANDAMENTO</option>
                    <option value="RESOLVIDO">RESOLVIDO</option>
                    <option value="FECHADO">FECHADO</option>
                </select>

                <label for="comentarioAdmin">Comentário do atendimento</label>
                <textarea id="comentarioAdmin" rows="4"
                          placeholder="Adicione orientações ou observações para o cliente"></textarea>

                <button id="btnSalvarAdmin" class="primary">Salvar alterações</button>
            </div>
        </div>
    </div>
</main>

<div id="footer"></div>

<script src="/script/includes.js"></script>
<script>
    const usuario = JSON.parse(localStorage.getItem("usuario"));
    if (!usuario) window.location.href = "/login.html";

    document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");

        const conteudo = document.getElementById("conteudoChamado");
        const adminBox = document.getElementById("adminBox");
        const statusSelect = document.getElementById("statusSelect");
        const comentarioAdmin = document.getElementById("comentarioAdmin");
        const btnSalvarAdmin = document.getElementById("btnSalvarAdmin");

        const isAdmin = usuario.nivel === 'ADMIN';

        async function carregar() {
            try {
                const res = await fetch(`/api/chamados/${id}?usuarioId=${usuario.id}`);
                if (!res.ok) throw new Error(res.status);
                const c = await res.json();

                const dataCriacao = c.dataCriacao ? new Date(c.dataCriacao).toLocaleString() : '-';

                conteudo.innerHTML = `
                    <h2>${c.titulo}</h2>

                    <p class="detalhes-meta">
                        <strong>Status:</strong>
                        <span class="status-badge status-${c.status}">${c.status}</span>
                    </p>

                    <p class="detalhes-meta">
                        <strong>Data de abertura:</strong> ${dataCriacao}
                    </p>

                    ${c.cliente ? `
                        <p class="detalhes-meta">
                            <strong>Cliente:</strong> [${c.cliente.id}] ${c.cliente.nome || ''}
                        </p>
                    ` : ''}

                    <h3>Descrição</h3>
                    <p class="detalhes-descricao">
                        ${c.descricao}
                    </p>

                    ${c.comentarioAdmin ? `
                        <div class="comentario-bloco">
                            <h3>Comentário do atendimento</h3>
                            <p>${c.comentarioAdmin}</p>
                        </div>
                    ` : ''}
                `;

                if (isAdmin) {
                    adminBox.style.display = 'block';
                    statusSelect.value = c.status;
                    comentarioAdmin.value = c.comentarioAdmin || '';
                }
            } catch (err) {
                conteudo.innerHTML =
                    `<p style="color:#ffb3b3;">Erro ao carregar chamado. Código: ${err.message}</p>`;
            }
        }

        if (isAdmin) {
            btnSalvarAdmin.addEventListener("click", async () => {
                try {
                    const res = await fetch(`/api/chamados/${id}/admin?adminId=${usuario.id}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            status: statusSelect.value,
                            comentarioAdmin: comentarioAdmin.value
                        })
                    });

                    if (!res.ok) throw new Error(res.status);

                    Toastify({
                        text: "Chamado atualizado com sucesso!",
                        duration: 2000,
                        gravity: "top",
                        position: "right",
                        style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                    }).showToast();

                    carregar();
                } catch (err) {
                    Toastify({
                        text: `Erro ao atualizar chamado (Código ${err.message})`,
                        duration: 2500,
                        gravity: "top",
                        position: "right",
                        style: { background: "linear-gradient(to right, #ff5f6d, #ffc371)" }
                    }).showToast();
                }
            });
        }

        carregar();
    });
</script>
</body>
</html>
