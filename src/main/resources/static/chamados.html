<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Meus Chamados</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<div class="container">
    <h1>üìã Meus Chamados</h1>

    <nav>
        <a href="/painel.html">üè† Voltar ao Painel</a> |
        <a href="#" id="logout">Sair</a>
    </nav>

    <div class="card">
        <h2>Abrir Novo Chamado</h2>
        <form id="formChamado">
            <input type="text" name="titulo" placeholder="T√≠tulo" required />
            <textarea name="descricao" placeholder="Descri√ß√£o detalhada" required></textarea>
            <button class="primary" type="submit">Abrir Chamado</button>
        </form>
        <div id="msgForm"></div>
    </div>

    <h2>üìÑ Lista de Chamados</h2>
    <div id="lista"></div>
</div>

<script>
    // üîê Verifica√ß√£o de login
    const usuario = JSON.parse(localStorage.getItem('usuario') || 'null');
    if (!usuario) {
        window.location.href = '/login.html';
    }

    // Logout
    document.getElementById('logout').addEventListener('click', () => {
        localStorage.removeItem('usuario');
        window.location.href = '/login.html';
    });

    const msgForm = document.getElementById('msgForm');
    const lista = document.getElementById('lista');

    // üß† Fun√ß√£o para carregar chamados
    async function carregarChamados() {
        try {
            const res = await fetch(`/api/chamados/cliente/${usuario.id}`);
            if (!res.ok) {
                throw new Error('Erro ao buscar chamados. C√≥digo: ' + res.status);
            }

            const data = await res.json();
            lista.innerHTML = '';

            if (!Array.isArray(data) || data.length === 0) {
                lista.innerHTML = '<p>Nenhum chamado encontrado.</p>';
                return;
            }

            data.forEach(chamado => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
            <strong>${chamado.titulo}</strong><br>
            <em>Status:</em> ${chamado.status}<br>
            <p>${chamado.descricao}</p>
            <small>Criado em: ${
                    chamado.dataCriacao
                        ? new Date(chamado.dataCriacao).toLocaleString('pt-BR')
                        : 'data n√£o informada'
                }</small>
          `;
                lista.appendChild(div);
            });
        } catch (err) {
            lista.innerHTML = `<p style="color:red;">‚ùå Erro: ${err.message}</p>`;
        }
    }

    // üßæ Submeter novo chamado
    const form = document.getElementById('formChamado');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const payload = Object.fromEntries(new FormData(form));
        payload.clienteId = usuario.id; // vincula o usu√°rio logado

        try {
            const res = await fetch('/api/chamados/criar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            const json = await res.json();

            if (res.ok) {
                msgForm.innerHTML = `<p style="color:green;">‚úÖ Chamado criado com sucesso!</p>`;
                form.reset();
                carregarChamados();
            } else {
                msgForm.innerHTML = `<p style="color:red;">‚ùå ${json.erro || 'Erro ao criar chamado'}</p>`;
            }
        } catch (err) {
            msgForm.innerHTML = `<p style="color:red;">‚ùå Erro: ${err.message}</p>`;
        }
    });

    // üöÄ Inicializa a lista
    carregarChamados();
</script>
</body>
</html>
