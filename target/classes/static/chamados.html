<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Chamados</title>

    <!-- Estilos globais -->
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!-- Toastify -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body>

<!-- Navbar -->
<div id="navbar"></div>

<!-- Conteúdo principal -->
<main>
    <div class="container">
        <h1 id="tituloPagina">Meus Chamados</h1>

        <!-- Filtros só para ADMIN -->
        <div id="adminFiltros" class="admin-filtros" style="display:none;">
            <h2>Filtros de Administração</h2>
            <div class="filtros-grid">
                <div>
                    <label for="filtroStatus">Status</label>
                    <select id="filtroStatus">
                        <option value="">Todos</option>
                        <option value="ABERTO">ABERTO</option>
                        <option value="EM_ANDAMENTO">EM ANDAMENTO</option>
                        <option value="RESOLVIDO">RESOLVIDO</option>
                        <option value="FECHADO">FECHADO</option>
                    </select>
                </div>
                <div>
                    <label for="filtroClienteId">ID do Cliente</label>
                    <input id="filtroClienteId" type="number" placeholder="Ex: 1">
                </div>
                <div class="filtros-botoes">
                    <button id="btnFiltrar" class="primary">Aplicar filtros</button>
                    <button id="btnLimpar" class="secondary">Limpar</button>
                </div>
            </div>
        </div>

        <div class="chamados-wrapper">

            <!-- Coluna esquerda: Formulário (esconde para ADMIN) -->
            <div class="form-section" id="formCriarChamado">
                <h2 style="margin-bottom: .8rem;">Criar novo chamado</h2>
                <input id="titulo" placeholder="Título do chamado"/>
                <textarea id="descricao" placeholder="Descrição detalhada"></textarea>
                <button id="btnCriar" class="primary">Criar Chamado</button>
            </div>

            <!-- Coluna direita: Lista -->
            <div class="lista-section">
                <h2>Chamados Registrados</h2>
                <div id="listaChamados"></div>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<div id="footer"></div>

<!-- Scripts -->
<script src="/script/includes.js"></script>
<script>
    // Protege rota
    const usuario = JSON.parse(localStorage.getItem('usuario'));
    if (!usuario) window.location.href = '/login.html';

    document.addEventListener("DOMContentLoaded", () => {
        const btnCriar = document.getElementById("btnCriar");
        const tituloInput = document.getElementById("titulo");
        const descricaoInput = document.getElementById("descricao");
        const lista = document.getElementById("listaChamados");

        const adminFiltros = document.getElementById("adminFiltros");
        const formCriar = document.getElementById("formCriarChamado");
        const tituloPagina = document.getElementById("tituloPagina");

        const filtroStatus = document.getElementById("filtroStatus");
        const filtroClienteId = document.getElementById("filtroClienteId");
        const btnFiltrar = document.getElementById("btnFiltrar");
        const btnLimpar = document.getElementById("btnLimpar");

        const isAdmin = usuario.nivel === 'ADMIN';

        // Se for ADMIN, mostra filtros e esconde o formulário de criação
        if (isAdmin) {
            adminFiltros.style.display = 'block';
            formCriar.style.display = 'none';
            tituloPagina.textContent = 'Chamados - Administração';
        }

        function renderLista(chamados) {
            lista.innerHTML = "";
            if (!chamados.length) {
                lista.innerHTML = "<p>Nenhum chamado encontrado.</p>";
                return;
            }

            chamados.forEach(c => {
                const item = document.createElement("div");
                item.classList.add("chamado");

                const data = c.dataCriacao ? new Date(c.dataCriacao).toLocaleString() : '-';

                item.innerHTML = `
                    <h3>
                        <a href="/detalhes.html?id=${c.id}" style="text-decoration:none;color:#2196f3;">
                            ${c.titulo}
                        </a>
                    </h3>

                    ${isAdmin && c.cliente ? `<p><strong>Cliente:</strong> [${c.cliente.id}] ${c.cliente.nome || ''}</p>` : ''}

                    <p><strong>Status:</strong> <span class="status-badge status-${c.status}">${c.status}</span></p>
                    <p><strong>Data:</strong> ${data}</p>

                    <p style="margin-top:.5rem;">${c.descricao}</p>
                `;

                lista.appendChild(item);
            });
        }

        // Carregar chamados do cliente COMUM
        async function carregarChamadosCliente() {
            try {
                const res = await fetch(`/api/chamados/cliente/${usuario.id}`);
                if (!res.ok) throw new Error(res.status);
                const chamados = await res.json();
                renderLista(chamados);
            } catch (err) {
                lista.innerHTML =
                    `<p style="color:red;">Erro ao buscar chamados. Código: ${err.message}</p>`;
            }
        }

        // Carregar chamados para ADMIN com filtros
        async function carregarChamadosAdmin() {
            try {
                let url = `/api/chamados/admin?adminId=${usuario.id}`;

                const status = filtroStatus.value;
                const clienteId = filtroClienteId.value;

                if (status) {
                    url += `&status=${status}`;
                }
                if (clienteId) {
                    url += `&clienteId=${clienteId}`;
                }

                const res = await fetch(url);
                if (!res.ok) throw new Error(res.status);
                const chamados = await res.json();
                renderLista(chamados);
            } catch (err) {
                lista.innerHTML =
                    `<p style="color:red;">Erro ao buscar chamados (admin). Código: ${err.message}</p>`;
            }
        }

        // Criar chamado (apenas COMUM)
        if (!isAdmin) {
            btnCriar.addEventListener("click", async () => {
                if (!tituloInput.value.trim() || !descricaoInput.value.trim()) {
                    Toastify({
                        text: "Preencha todos os campos!",
                        duration: 2000,
                        gravity: "top",
                        position: "right",
                        style: { background: "linear-gradient(to right, #ff5f6d, #ffc371)" }
                    }).showToast();
                    return;
                }

                try {
                    const res = await fetch("/api/chamados", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            titulo: tituloInput.value,
                            descricao: descricaoInput.value,
                            clienteId: usuario.id
                        })
                    });

                    if (!res.ok) throw new Error(res.status);

                    tituloInput.value = "";
                    descricaoInput.value = "";

                    Toastify({
                        text: "Chamado criado com sucesso!",
                        duration: 2000,
                        gravity: "top",
                        position: "right",
                        style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                    }).showToast();

                    carregarChamadosCliente();
                } catch (err) {
                    Toastify({
                        text: `Erro ao criar chamado (Código ${err.message})`,
                        duration: 2500,
                        gravity: "top",
                        position: "right",
                        style: { background: "linear-gradient(to right, #ff5f6d, #ffc371)" }
                    }).showToast();
                }
            });
        }

        // Eventos dos filtros (ADMIN)
        if (isAdmin) {
            btnFiltrar.addEventListener("click", () => {
                carregarChamadosAdmin();
            });

            btnLimpar.addEventListener("click", () => {
                filtroStatus.value = "";
                filtroClienteId.value = "";
                carregarChamadosAdmin();
            });
        }

        // Inicial
        if (isAdmin) {
            carregarChamadosAdmin();
        } else {
            carregarChamadosCliente();
        }
    });
</script>
</body>
</html>
