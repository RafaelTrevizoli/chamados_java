<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meus Chamados</title>

    <!-- Estilos globais -->
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <!-- Toastify -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body>

<!-- Navbar -->
<div id="navbar"></div>

<!-- Conteúdo principal -->
<main>
    <div class="container">
        <h1>Meus Chamados</h1>

        <div class="chamados-wrapper">

            <!-- Coluna esquerda: Formulário -->
            <div class="form-section">
                <h2 style="margin-bottom: .8rem;">Criar novo chamado</h2>
                <input id="titulo" placeholder="Título do chamado"/>
                <textarea id="descricao" placeholder="Descrição detalhada"></textarea>
                <button id="btnCriar" class="primary">Criar Chamado</button>
            </div>

            <!-- Coluna direita: Lista -->
            <div class="lista-section">
                <h2>Chamados Registrados</h2>
                <div id="listaChamados"></div>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<div id="footer"></div>

<!-- Scripts -->
<script src="/script/includes.js"></script>
<script>
    // Protege rota
    const usuario = JSON.parse(localStorage.getItem('usuario'));
    if (!usuario) window.location.href = '/login.html';

    document.addEventListener("DOMContentLoaded", () => {
        const btnCriar = document.getElementById("btnCriar");
        const titulo = document.getElementById("titulo");
        const descricao = document.getElementById("descricao");
        const lista = document.getElementById("listaChamados");

        // Carregar chamados do usuário
        async function carregarChamados() {
            try {
                const res = await fetch(`/api/chamados/cliente/${usuario.id}`);
                if (!res.ok) throw new Error(res.status);
                const chamados = await res.json();

                lista.innerHTML = "";
                chamados.forEach(c => {
                    const item = document.createElement("div");
                    item.classList.add("chamado");

                    item.innerHTML = `
                        <h3>
                            <a href="/detalhes.html?id=${c.id}" style="text-decoration:none;color:#2196f3;">
                                ${c.titulo}
                            </a>
                        </h3>

                        <p><strong>Status:</strong> ${c.status}</p>
                        <p><strong>Data:</strong> ${new Date(c.dataCriacao).toLocaleString()}</p>

                        <p style="margin-top:.5rem;">${c.descricao}</p>
                    `;

                    lista.appendChild(item);
                });
            } catch (err) {
                lista.innerHTML =
                    `<p style="color:red;">Erro ao buscar chamados. Código: ${err.message}</p>`;
            }
        }

        // Criar chamado
        btnCriar.addEventListener("click", async () => {
            if (!titulo.value.trim() || !descricao.value.trim()) {
                Toastify({
                    text: "Preencha todos os campos!",
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    style: { background: "linear-gradient(to right, #ff5f6d, #ffc371)" }
                }).showToast();
                return;
            }

            try {
                const res = await fetch("/api/chamados", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        titulo: titulo.value,
                        descricao: descricao.value,
                        clienteId: usuario.id
                    })
                });

                if (!res.ok) throw new Error(res.status);

                titulo.value = "";
                descricao.value = "";

                Toastify({
                    text: "Chamado criado com sucesso!",
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                }).showToast();

                carregarChamados();
            } catch (err) {
                Toastify({
                    text: `Erro ao criar chamado (Código ${err.message})`,
                    duration: 2500,
                    gravity: "top",
                    position: "right",
                    style: { background: "linear-gradient(to right, #ff5f6d, #ffc371)" }
                }).showToast();
            }
        });

        carregarChamados();
    });
</script>
</body>
</html>
